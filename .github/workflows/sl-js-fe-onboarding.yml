name: SeaLights Onboarding - JS FE

on:
  workflow_dispatch:

jobs:
  sealights-onboarding:
    runs-on: ubuntu-latest

    env:
      HUSKY: 0
      PORT: 8089
      CYPRESS_SL_ENABLE_REMOTE_AGENT: true
      CYPRESS_SL_TEST_STAGE: "Cypress Tests"
      CYPRESS_SL_LAB_ID: "nodetests"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 18.20.8
        uses: actions/setup-node@v4
        with:
          node-version: 18.20.8

      - name: Use npm 10.8.2
        run: npm install -g npm@10.8.2

      - name: Install dependencies
        run: |
          export HUSKY=0
          npm ci

      - name: Download SeaLights Node.js agent
        run: npm install slnodejs

      - name: Create SL token file
        run: echo "${{ secrets.SL_TOKEN }}" > sltoken.txt

      - name: Configure SeaLights build
        run: |
          npx slnodejs config \
            --tokenfile ./sltoken.txt \
            --appname demo_js_fe \
            --branch main \
            --build "$(date +"%y%m%d_%H%M")" \
            --output buildSessionId

      - name: Scan and instrument code
        run: |
          npx slnodejs scan \
            --tokenfile ./sltoken.txt \
            --buildsessionidfile buildSessionId \
            --labid nodetests \
            --instrumentForBrowsers \
            --workspacepath ./app \
            --outputpath sl_app \
            --scm none \
            --es6Modules

      - name: Replace original app with instrumented code
        run: |
          mv app app_original
          mv sl_app app

      - name: Start instrumented app in background
        run: |
          nohup npm start > server.log 2>&1 &
          sleep 10
          curl -f http://localhost:${PORT} || (echo "App failed to start" && cat server.log && exit 1)

      - name: Install Cypress and SeaLights plugin
        run: |
          npm install --save-dev cypress sealights-cypress-plugin

      - name: Export Cypress environment variables
        run: |
          export CYPRESS_SL_TOKEN="${{ secrets.SL_TOKEN }}"
          export CYPRESS_SL_BUILD_SESSION_ID=$(cat buildSessionId)
          echo "Using build session ID: $CYPRESS_SL_BUILD_SESSION_ID"

      - name: Run Cypress tests with SeaLights plugin
        run: |
          export CYPRESS_SL_TOKEN="${{ secrets.SL_TOKEN }}"
          export CYPRESS_SL_BUILD_SESSION_ID=$(cat buildSessionId)
          npx sealights-cypress-plugin npx cypress run --spec "cypress/e2e/**/*.cy.js" | tee cypress_output.txt

      - name: Stop background app
        if: always()
        run: |
          pkill node || true
          echo "Stopped instrumented app"
